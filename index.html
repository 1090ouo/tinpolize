<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pixelate</title>
  <style>
    body{margin:0;padding:20px;background:#111;color:#eee;font-family:sans-serif}
    #controls{margin-bottom:10px}
    canvas{image-rendering:pixelated;max-width:100%;height:auto;background:#222}
  </style>
</head>
<body>
  <div id="controls">
    <input id="file" type="file" accept="image/*">
    <label>横ブロック数: <span id="nLabel">32</span></label>
    <input id="nRange" type="range" min="2" max="512" value="32">
    <button id="applyBtn">適用</button>
    <button id="downloadBtn">ダウンロード</button>
  </div>
  <canvas id="canvas"></canvas>
<script>
(() => {
  const fileEl = document.getElementById('file');
  const nRange = document.getElementById('nRange');
  const nLabel = document.getElementById('nLabel');
  const applyBtn = document.getElementById('applyBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  let img = new Image();
  let imgLoaded = false;
  let originalW = 0, originalH = 0;

  nRange.addEventListener('input', () => nLabel.textContent = nRange.value);

  fileEl.addEventListener('change', e => {
    if(e.target.files[0]) handleFile(e.target.files[0]);
  });

  function handleFile(file){
    const reader = new FileReader();
    reader.onload = ev => {
      img = new Image();
      img.onload = () => {
        imgLoaded = true;
        originalW = img.width; originalH = img.height;
        canvas.width = originalW; canvas.height = originalH;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,0,0);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  }

  function applyPixelate(){
    if(!imgLoaded){ return }
    const n = Math.max(2, parseInt(nRange.value,10));

    const srcW = originalW, srcH = originalH;
    const tmpSmall = document.createElement('canvas');
    const smallW = n;
    const smallH = Math.max(1, Math.round(n * srcH / srcW));
    tmpSmall.width = smallW; tmpSmall.height = smallH;
    const tmpCtx = tmpSmall.getContext('2d');
    tmpCtx.imageSmoothingEnabled = true;
    tmpCtx.drawImage(img, 0, 0, smallW, smallH);

    ctx.imageSmoothingEnabled = false;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(tmpSmall, 0, 0, srcW, srcH);
  }

  function download(){
    if(!imgLoaded){ return }
    const a = document.createElement('a');
    a.href = canvas.toDataURL('image/png');
    a.download = 'pixelated.png';
    a.click();
  }

  applyBtn.addEventListener('click', applyPixelate);
  downloadBtn.addEventListener('click', download);
})();
</script>
</body>
</html>
